---
// Problem/Agitation/Solution (PAS) section
// Fetches content from Sanity CMS with i18n fallback
import i18next from '../i18next.config';
import { getPageContentWithFallback } from '../../sanity/lib/pageContent';
import { getLocaleFromPathname } from '../utils/i18n';

const { t } = i18next;

// Get current language from URL
const currentLang = getLocaleFromPathname(Astro.url.pathname) || 'en';

// Fetch page content from Sanity
let pageContent = null;
try {
  pageContent = await getPageContentWithFallback('home', currentLang);
} catch (e) {
  console.warn('Could not fetch page content from Sanity, using i18n fallback');
}

// Use Sanity content with i18n fallback
const problemSolution = pageContent?.problemSolution;
const sectionLabel = problemSolution?.sectionBadge || t('pages:problem_solution.label');
const sectionTitle = problemSolution?.title || t('pages:problem_solution.title');
const sectionSubtitle = problemSolution?.subtitle || t('pages:problem_solution.subtitle');
const solutionLabel = problemSolution?.solutionLabel || t('pages:problem_solution.solution_label');
const solutionTitle = problemSolution?.solutionTitle || t('pages:problem_solution.solution_title');
const solutionDescription = problemSolution?.solutionDescription || t('pages:problem_solution.solution_description');

// Problem cards with Sanity fallback
const problems = problemSolution?.problems || [
  {
    icon: 'trash',
    title: t('pages:problem_solution.problems.paper_cards.title'),
    description: t('pages:problem_solution.problems.paper_cards.description'),
    color: 'red'
  },
  {
    icon: 'phone',
    title: t('pages:problem_solution.problems.app_fatigue.title'),
    description: t('pages:problem_solution.problems.app_fatigue.description'),
    color: 'orange'
  },
  {
    icon: 'face-frown',
    title: t('pages:problem_solution.problems.no_data.title'),
    description: t('pages:problem_solution.problems.no_data.description'),
    color: 'yellow'
  }
];

const solutionHighlights = problemSolution?.solutionHighlights || [
  'No app downloads',
  'No lost cards',
  'Real-time analytics'
];
---

<section id="problem-solution" class="py-20 bg-[var(--bg-primary)]">
  <div class="mx-auto max-w-7xl px-6">
    <!-- Section Header -->
    <div class="text-center mb-16">
      <div class="inline-flex items-center gap-2 rounded-full border border-[var(--border-color)] bg-[var(--bg-secondary)]/50 px-3 py-1 text-xs text-[var(--text-secondary)] backdrop-blur mb-4">
        <span>{sectionLabel}</span>
      </div>
      <h2 class="text-4xl font-bold tracking-tight sm:text-5xl text-[var(--text-primary)]">
        {sectionTitle}
      </h2>
      <p class="mt-4 text-lg text-[var(--text-secondary)] max-w-2xl mx-auto">
        {sectionSubtitle}
      </p>
    </div>

    <!-- Problem Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto mb-16">
      <!-- Paper Cards Problem -->
      <div class="problem-card group relative rounded-2xl border border-red-500/20 bg-red-500/5 p-8">
        <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-red-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
        <div class="relative">
          <div class="w-12 h-12 bg-red-500/10 rounded-lg flex items-center justify-center mb-6">
            <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold mb-3 text-[var(--text-primary)]">
            {t('pages:problem_solution.problems.paper_cards.title')}
          </h3>
          <p class="text-[var(--text-secondary)] leading-relaxed">
            {t('pages:problem_solution.problems.paper_cards.description')}
          </p>
        </div>
      </div>

      <!-- App Fatigue Problem -->
      <div class="problem-card group relative rounded-2xl border border-orange-500/20 bg-orange-500/5 p-8">
        <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-orange-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
        <div class="relative">
          <div class="w-12 h-12 bg-orange-500/10 rounded-lg flex items-center justify-center mb-6">
            <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold mb-3 text-[var(--text-primary)]">
            {t('pages:problem_solution.problems.app_fatigue.title')}
          </h3>
          <p class="text-[var(--text-secondary)] leading-relaxed">
            {t('pages:problem_solution.problems.app_fatigue.description')}
          </p>
        </div>
      </div>

      <!-- No Data Problem -->
      <div class="problem-card group relative rounded-2xl border border-yellow-500/20 bg-yellow-500/5 p-8">
        <div class="absolute inset-0 rounded-2xl bg-gradient-to-br from-yellow-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
        <div class="relative">
          <div class="w-12 h-12 bg-yellow-500/10 rounded-lg flex items-center justify-center mb-6">
            <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold mb-3 text-[var(--text-primary)]">
            {t('pages:problem_solution.problems.no_data.title')}
          </h3>
          <p class="text-[var(--text-secondary)] leading-relaxed">
            {t('pages:problem_solution.problems.no_data.description')}
          </p>
        </div>
      </div>
    </div>

    <!-- Arrow Divider -->
    <div class="flex justify-center mb-16">
      <div class="solution-arrow w-16 h-16 rounded-full bg-gradient-to-br from-[#8b5cf6] to-[#a78bfa] flex items-center justify-center shadow-lg shadow-[#8b5cf6]/20">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
        </svg>
      </div>
    </div>

    <!-- Solution Block -->
    <div class="solution-block max-w-4xl mx-auto">
      <div class="relative rounded-3xl border border-[#8b5cf6]/30 bg-gradient-to-br from-[#8b5cf6]/10 via-[var(--bg-secondary)]/50 to-[#a78bfa]/10 p-8 md:p-12 overflow-hidden">
        <!-- Background glow -->
        <div class="absolute -top-24 -right-24 w-48 h-48 bg-[#8b5cf6]/20 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-24 -left-24 w-48 h-48 bg-[#a78bfa]/20 rounded-full blur-3xl"></div>

        <div class="relative text-center">
          <div class="inline-flex items-center gap-2 rounded-full border border-[#8b5cf6]/30 bg-[#8b5cf6]/10 px-3 py-1 text-xs text-[#8b5cf6] mb-6">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>{solutionLabel}</span>
          </div>

          <h3 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)] mb-4">
            {solutionTitle}
          </h3>

          <p class="text-lg text-[var(--text-secondary)] max-w-2xl mx-auto">
            {solutionDescription}
          </p>

          <!-- Solution highlights -->
          <div class="mt-8 flex flex-wrap justify-center gap-4">
            {solutionHighlights.map((highlight) => (
              <div class="flex items-center gap-2 text-sm text-[var(--text-primary)]">
                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>{highlight}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Motion animations -->
  <script type="module">
    import { animate, inView, stagger } from "motion";

    inView("#problem-solution .problem-card", ({ target }) => {
      animate(
        "#problem-solution .problem-card",
        { opacity: [0, 1], y: [30, 0] },
        { duration: 0.6, easing: "ease-out", delay: stagger(0.15) }
      );
    }, { amount: 0.3 });

    inView("#problem-solution .solution-arrow", ({ target }) => {
      animate(target, { opacity: [0, 1], scale: [0.5, 1] }, { duration: 0.5, easing: "ease-out" });
    });

    inView("#problem-solution .solution-block", ({ target }) => {
      animate(target, { opacity: [0, 1], y: [40, 0] }, { duration: 0.8, easing: "ease-out" });
    });
  </script>
</section>
