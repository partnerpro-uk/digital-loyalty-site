---
// Lead Capture Form - Email only for newsletter/updates
import i18next from '../../i18next.config';

const { t } = i18next;

interface Props {
  formId?: string;
  buttonText?: string;
  placeholder?: string;
  variant?: 'default' | 'inline' | 'dark';
}

const {
  formId = 'lead-capture',
  buttonText = t('common:buttons.get_started'),
  placeholder = t('common:forms.email_placeholder'),
  variant = 'default'
} = Astro.props;

// Style variants
const variants = {
  default: {
    input: 'bg-[var(--bg-primary)] border-[var(--border-color)] text-[var(--text-primary)] placeholder:text-[var(--text-secondary)]',
    button: 'bg-gradient-to-r from-[#8b5cf6] to-[#a78bfa] text-white hover:shadow-lg hover:shadow-[#8b5cf6]/20'
  },
  inline: {
    input: 'bg-[var(--bg-secondary)]/50 border-[var(--border-color)] text-[var(--text-primary)] placeholder:text-[var(--text-secondary)]',
    button: 'bg-[#8b5cf6] text-white hover:bg-[#7c3aed]'
  },
  dark: {
    input: 'bg-white/10 border-white/20 text-white placeholder:text-white/60',
    button: 'bg-white text-[#7c3aed] hover:bg-white/90'
  }
};

const styles = variants[variant];
---

<form
  id={formId}
  class="lead-capture-form"
  data-netlify="true"
  netlify-honeypot="bot-field"
>
  <!-- Honeypot for spam prevention -->
  <p class="hidden">
    <label>
      Don't fill this out if you're human: <input name="bot-field" />
    </label>
  </p>

  <div class="flex flex-col sm:flex-row gap-3">
    <div class="flex-1 relative">
      <input
        type="email"
        name="email"
        required
        placeholder={placeholder}
        class={`w-full px-5 py-3.5 rounded-full border text-base focus:outline-none focus:ring-2 focus:ring-[#8b5cf6]/50 focus:border-[#8b5cf6] transition-all ${styles.input}`}
        aria-label={t('common:forms.email_label')}
      />
      <span class="form-error hidden absolute -bottom-6 left-4 text-red-500 text-xs">
        {t('common:forms.invalid_email')}
      </span>
    </div>

    <button
      type="submit"
      class={`px-8 py-3.5 rounded-full font-semibold text-base transition-all duration-300 flex items-center justify-center gap-2 ${styles.button}`}
    >
      <span class="button-text">{buttonText}</span>
      <span class="button-loading hidden">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </span>
    </button>
  </div>

  <!-- Success message -->
  <div class="form-success hidden mt-4 p-4 rounded-xl bg-green-500/10 border border-green-500/20 text-green-600 text-sm text-center">
    <div class="flex items-center justify-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      <span>{t('common:forms.success_message')}</span>
    </div>
  </div>

  <!-- Error message -->
  <div class="form-error-message hidden mt-4 p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-red-600 text-sm text-center">
    <span>{t('common:forms.error_message')}</span>
  </div>
</form>

<script>
  document.querySelectorAll('.lead-capture-form').forEach((form) => {
    const emailInput = form.querySelector('input[type="email"]') as HTMLInputElement;
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const buttonText = form.querySelector('.button-text') as HTMLElement;
    const buttonLoading = form.querySelector('.button-loading') as HTMLElement;
    const successMsg = form.querySelector('.form-success') as HTMLElement;
    const errorMsg = form.querySelector('.form-error-message') as HTMLElement;
    const fieldError = form.querySelector('.form-error') as HTMLElement;

    // Email validation
    emailInput?.addEventListener('input', () => {
      const isValid = emailInput.validity.valid;
      if (fieldError) {
        fieldError.classList.toggle('hidden', isValid || emailInput.value === '');
      }
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!emailInput?.validity.valid) {
        fieldError?.classList.remove('hidden');
        return;
      }

      // Start loading state
      if (buttonText) buttonText.classList.add('hidden');
      if (buttonLoading) buttonLoading.classList.remove('hidden');
      if (submitBtn) submitBtn.disabled = true;

      // Track form start if PostHog is available
      if (window.posthog) {
        window.posthog.capture('form_submitted', {
          form_id: form.id,
          form_type: 'lead_capture'
        });
      }

      try {
        // Submit to Netlify Forms
        const formData = new FormData(form as HTMLFormElement);

        const response = await fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(formData as any).toString()
        });

        if (response.ok) {
          // Show success
          successMsg?.classList.remove('hidden');
          errorMsg?.classList.add('hidden');
          (form as HTMLFormElement).reset();

          // Track success
          if (window.posthog) {
            window.posthog.capture('form_success', { form_id: form.id });
          }
        } else {
          throw new Error('Form submission failed');
        }
      } catch (error) {
        // Show error
        errorMsg?.classList.remove('hidden');
        successMsg?.classList.add('hidden');

        // Track error
        if (window.posthog) {
          window.posthog.capture('form_error', { form_id: form.id });
        }
      } finally {
        // Reset button state
        if (buttonText) buttonText.classList.remove('hidden');
        if (buttonLoading) buttonLoading.classList.add('hidden');
        if (submitBtn) submitBtn.disabled = false;
      }
    });
  });

  // Type declaration for PostHog
  declare global {
    interface Window {
      posthog?: {
        capture: (event: string, properties?: Record<string, any>) => void;
      };
    }
  }
</script>
