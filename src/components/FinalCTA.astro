---
// Final CTA section (Footer Sink) - Bottom conversion section
// Fetches content from Sanity CMS with i18n fallback
// Supports configurable CTA modes: form_modal, form_page, app_redirect, calendar
import i18next from '../i18next.config';
import { getPageContentWithFallback } from '../../sanity/lib/pageContent';
import { getLocaleFromPathname } from '../utils/i18n';
import SmartCTA from './SmartCTA.astro';

const { t } = i18next;

// Get current language from URL
const currentLang = getLocaleFromPathname(Astro.url.pathname) || 'en';

// Fetch page content from Sanity
let pageContent = null;
try {
  pageContent = await getPageContentWithFallback('home', currentLang);
} catch (e) {
  console.warn('Could not fetch page content from Sanity, using i18n fallback');
}

// Use Sanity content with i18n fallback
const finalCta = pageContent?.finalCta;
const ctaTitle = finalCta?.title || t('pages:final_cta.title');
const ctaSubtitle = finalCta?.subtitle || t('pages:final_cta.subtitle');
const primaryCtaText = finalCta?.primaryCta?.text || t('pages:final_cta.primary_cta');
const secondaryCtaText = finalCta?.secondaryCta?.text || t('pages:final_cta.secondary_cta');
const secondaryCtaUrl = finalCta?.secondaryCta?.url || '#demo';
const trustIndicators = finalCta?.trustIndicators || [
  'No credit card required',
  '14-day free trial',
  'Cancel anytime'
];
const trustText = t('pages:final_cta.trust_text');
---

<section id="final-cta" class="py-20 bg-gradient-to-br from-[#8b5cf6] via-[#7c3aed] to-[#6d28d9] relative overflow-hidden">
  <!-- Background patterns -->
  <div class="absolute inset-0 opacity-30">
    <div class="absolute top-0 left-0 w-96 h-96 bg-white/10 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2"></div>
    <div class="absolute bottom-0 right-0 w-96 h-96 bg-white/10 rounded-full blur-3xl translate-x-1/2 translate-y-1/2"></div>
    <div class="absolute top-1/2 left-1/2 w-64 h-64 bg-white/5 rounded-full blur-2xl -translate-x-1/2 -translate-y-1/2"></div>
  </div>

  <!-- Grid pattern overlay -->
  <div class="absolute inset-0 opacity-10" style="background-image: url(&quot;data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E&quot;);"></div>

  <div class="relative mx-auto max-w-7xl px-6">
    <div class="text-center">
      <!-- Main headline -->
      <h2 class="cta-title text-4xl font-bold tracking-tight sm:text-5xl lg:text-6xl text-white mb-6">
        {ctaTitle}
      </h2>

      <!-- Subheadline -->
      <p class="cta-subtitle text-xl text-white/80 max-w-2xl mx-auto mb-10">
        {ctaSubtitle}
      </p>

      <!-- CTA Buttons -->
      <div class="cta-buttons flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <!-- Primary CTA - Configurable via Sanity -->
        <SmartCTA
          id="final-cta"
          text={primaryCtaText}
          variant="secondary"
          size="lg"
          context={{ source: 'final_cta' }}
          showArrow={true}
          class="group bg-white text-[#7c3aed] shadow-xl shadow-black/20 hover:shadow-2xl hover:shadow-black/30 hover:scale-105"
        />

        <!-- Secondary CTA -->
        <a
          href={secondaryCtaUrl}
          class="inline-flex items-center justify-center gap-2 px-8 py-4 rounded-full border-2 border-white/30 text-white font-semibold text-lg hover:bg-white/10 hover:border-white/50 transition-all duration-300"
        >
          {secondaryCtaText}
        </a>
      </div>

      <!-- Trust indicators (from Sanity) -->
      <div class="cta-trust flex flex-wrap justify-center items-center gap-6 text-white/70 text-sm">
        {trustIndicators.map((indicator) => (
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>{indicator}</span>
          </div>
        ))}
      </div>

      <!-- Social proof -->
      <p class="cta-social-proof mt-8 text-white/60 text-sm">
        {trustText}
      </p>
    </div>
  </div>

  <!-- Motion animations -->
  <script type="module">
    import { animate, inView, stagger } from "motion";

    inView("#final-cta", () => {
      animate(
        "#final-cta .cta-title",
        { opacity: [0, 1], y: [30, 0] },
        { duration: 0.6, easing: "ease-out" }
      );

      animate(
        "#final-cta .cta-subtitle",
        { opacity: [0, 1], y: [20, 0] },
        { duration: 0.6, easing: "ease-out", delay: 0.1 }
      );

      animate(
        "#final-cta .cta-buttons",
        { opacity: [0, 1], y: [20, 0] },
        { duration: 0.6, easing: "ease-out", delay: 0.2 }
      );

      animate(
        "#final-cta .cta-trust",
        { opacity: [0, 1] },
        { duration: 0.6, easing: "ease-out", delay: 0.3 }
      );

      animate(
        "#final-cta .cta-social-proof",
        { opacity: [0, 1] },
        { duration: 0.6, easing: "ease-out", delay: 0.4 }
      );
    }, { amount: 0.3 });
  </script>
</section>
